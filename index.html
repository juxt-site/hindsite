<!DOCTYPE html>
<html>
  <head>
    <title>Site Surveyor</title>
    <meta charset="UTF-8">

    <link rel="icon" href="data:,">

    <link rel="stylesheet" href="https://edwardtufte.github.io/tufte-css/tufte.css"/>
    <!--
	<link rel="stylesheet" href="https://unpkg.com/@picocss/pico@1.*/css/pico.min.css">
	-->

	<script src="https://unpkg.com/htmx.org@1.8.5"
		integrity="sha384-7aHh9lqPYGYZ7sTHvzP1t3BAfLhYSTy9ArHdP3Xsr9/3TlGurYgcPBoFmXX2TX/w"
		crossorigin="anonymous"></script>

	<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

	<style>
	  table {
	      border: 1px solid black;
	      border-collapse: collapse;
	  }
	  table td {
	      border: 1px solid black;
	      padding: 2pt;
	  }
	  img {
	      box-shadow: -5px 5px 5px -5px rgba(80, 80, 80);
	      margin: 0 1em;
	  }

	</style>

  </head>

  <body>

    <main
      x-data="{authServer: 'https://auth.site.test',
	      apiServer: 'https://data.site.test'
	      }"
      class="container">

      <img style="float: right" src="surveyor.jpg">

      <h1>Site Surveyor</h1>

      <p>Welcome to Site Surveyor!
	This is a website that talks to your Site instance.</p>

      <h3>Authorize</h3>
      <p>Before we can continue, we must first acquire an <b>access token</b> which will be used to talk to your Site instance.</p>

      <div>
	<p>First, let's configure the location of your authorization server.</p>

	<label for="authServer">Authorization Server</label>
	<input id="authServer" x-model="authServer"
	       placeholder="Authorization Server...">

	<p>Click
	  <a :href="authServer + '/oauth/authorize?client_id=surveyor&response_type=token'">here</a>
	  to get your token!</p>

	<div>
	  <label for="access-token">Access Token</label>
	  <input id="access-token">
	</div>

	<div>
	  <label for="apiServer">API Server</label>
	  <input id="apiServer" x-model="apiServer"
		 placeholder="API Server...">
	</div>

      </div>


      <br style="clear: both">

      <section>
	<h2>Operations</h2>

	<div class="epigraph">
	  <blockquote>
	    For every action, there is an equal and opposite reaction.
	    <footer>Isaac Newton</footer>
	  </blockquote>
	</div>

	<p style="display: none">
	  Until we acquire an <i>access token</i>, these will be just the 'public' operations!
	</p>

	<figure class="fullwidth">
	  <h3>List of Operations</h3>
	  <div class="authorized"
	       :hx-get="apiServer + '/_site/operations.html'"
	       hx-trigger="load">
	    <code>
	      Loading operations...
	    </code>
	  </div>
	</figure>

      </section>

      <section>
	<h2>Users</h2>

	<figure class="fullwidth">
	  <h3>List of Users</h3>
	  <div class="authorized"
	       :hx-get="apiServer + '/_site/users.html'"
	       hx-trigger="load">
	    <code>
	      Loading users...
	    </code>
	    <aside>(note: this won't complete until we have authorization working!)</aside>
	  </div>

	</figure>

	<h3>mal</h3>
	<div class="authorized" :hx-get="authServer + '/users/mal'" hx-trigger="load">
	  <code>
	    Loading mal...
	  </code>
	</div>

      </section>

    </main>

    <script>
      // This is for extracting the access_token, if there is one,
      // from the URI fragment, displaying it and setting it in the
      // Authorization header for htmx requests.
      const accessToken = new
      URLSearchParams(location.hash.substring(1)).get("access_token");
      if (accessToken) {
	document.getElementById("access-token").setAttribute("value", accessToken);
      }

      const getAuthorizationHeader = function () { "Bearer" + accessToken };

      for (const el of document.getElementsByClassName("authorized")) {
	el.setAttribute("hx-headers",
			JSON.stringify({"authorization": "Bearer " + accessToken}))
      }
    </script>

  </body>
</html>
